name: Fiscal Module CI/CD

on:
  push:
    branches: [feature/fiscal-module, dev]
  pull_request:
    branches: [main, dev]

env:
  PYTHON_VERSION: "3.11"

jobs:
  security-scan:
    name: Security Scanning (SAST/SCA)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          pip install bandit safety

      - name: Run Bandit (SAST)
        run: |
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/ -ll
        continue-on-error: true

      - name: Run Safety (SCA)
        run: |
          safety check --json > safety-report.json || true
          safety check
        continue-on-error: true

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install black pylint isort

      - name: Check code formatting (Black)
        run: |
          black --check app/ config/ || (echo "Run 'black app/ config/' to fix" && exit 1)

      - name: Check import sorting (isort)
        run: |
          isort --check-only app/ config/ || (echo "Run 'isort app/ config/' to fix" && exit 1)

      - name: Run Pylint
        run: |
          pylint app/ --output-format=text --exit-zero > pylint-report.txt
          cat pylint-report.txt

      - name: Upload Pylint Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pylint-report
          path: pylint-report.txt

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-django coverage

      - name: Run Unit Tests with Coverage
        run: |
          coverage run -m pytest tests/ -m unit -v
          coverage report
          coverage html

      - name: Check Coverage Threshold
        run: |
          coverage report --fail-under=80

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: htmlcov/

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: .coverage
          fail_ci_if_error: false

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-django

      - name: Run Integration Tests
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_NAME: test_db
          DB_USER: root
          DB_PASSWORD: test_password
        run: |
          pytest tests/ -m integration -v

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality, unit-tests, integration-tests]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"

      - name: Fail if any job failed
        if: |
          needs.security-scan.result == 'failure' ||
          needs.code-quality.result == 'failure' ||
          needs.unit-tests.result == 'failure' ||
          needs.integration-tests.result == 'failure'
        run: exit 1
