{% extends "base.html" %}
{% load static %}

{% block title %}Analytics IA{% endblock %}

{% block extra_css %}
<style>
    .analytics-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .analytics-header {
        margin-bottom: 30px;
    }

    .analytics-header h2 {
        color: var(--primary-color, #333);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .analytics-header h2 i {
        color: var(--accent-color, #667eea);
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 24px;
        color: white;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
    }

    .stat-card.sales {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        box-shadow: 0 10px 30px rgba(17, 153, 142, 0.3);
    }

    .stat-card.sales:hover {
        box-shadow: 0 15px 40px rgba(17, 153, 142, 0.4);
    }

    .stat-card.alert {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        box-shadow: 0 10px 30px rgba(235, 51, 73, 0.3);
    }

    .stat-card.alert:hover {
        box-shadow: 0 15px 40px rgba(235, 51, 73, 0.4);
    }

    .stat-card .stat-icon {
        font-size: 2.5rem;
        opacity: 0.8;
        margin-bottom: 10px;
    }

    .stat-card .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .stat-card .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    /* AI Section */
    .ai-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }

    @media (max-width: 1024px) {
        .ai-section {
            grid-template-columns: 1fr;
        }
    }

    .ai-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e8ecf4;
    }

    .ai-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f2f5;
    }

    .ai-card-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
    }

    .ai-card-title i {
        color: #667eea;
    }

    .ai-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .ai-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .ai-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .ai-btn.loading i {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Summary Content */
    .summary-content {
        min-height: 200px;
        padding: 20px;
        background: #f8f9fc;
        border-radius: 12px;
        line-height: 1.7;
        color: #444;
    }

    .summary-content.empty {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #888;
        font-style: italic;
    }

    .summary-content p {
        margin-bottom: 12px;
    }

    /* Question Form */
    .question-form {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
    }

    .question-input {
        flex: 1;
        padding: 14px 18px;
        border: 2px solid #e8ecf4;
        border-radius: 12px;
        font-size: 1rem;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .question-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .question-input::placeholder {
        color: #aab;
    }

    /* Chat History */
    .chat-history {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .chat-message {
        margin-bottom: 16px;
        padding: 16px;
        border-radius: 12px;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .chat-message.user {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: 20%;
    }

    .chat-message.assistant {
        background: #f0f2f5;
        color: #333;
        margin-right: 10%;
    }

    .chat-message .message-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.7;
        margin-bottom: 8px;
    }

    .chat-message .message-text {
        line-height: 1.6;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #888;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    /* Loading Animation */
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 16px;
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: #667eea;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <div class="analytics-header">
        <h2><i class="fas fa-brain"></i> Analytics con Inteligencia Artificial</h2>
        <p style="color: #666; margin-top: 8px;">Análisis inteligente de tu negocio powered by DeepSeek AI</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card sales">
            <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
            <div class="stat-value" id="ventasHoyTotal">${{ quick_stats.ventas_hoy_total|floatformat:0|default:"0" }}</div>
            <div class="stat-label">Ventas Hoy ({{ quick_stats.ventas_hoy_cantidad|default:"0" }} transacciones)</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
            <div class="stat-value">{{ quick_stats.fecha|default:"--" }}</div>
            <div class="stat-label">Fecha Actual</div>
        </div>
        <div class="stat-card alert">
            <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="stat-value">{{ quick_stats.productos_stock_bajo|default:"0" }}</div>
            <div class="stat-label">Productos con Stock Bajo</div>
        </div>
    </div>

    <!-- AI Section -->
    <div class="ai-section">
        <!-- Daily Summary -->
        <div class="ai-card">
            <div class="ai-card-header">
                <div class="ai-card-title">
                    <i class="fas fa-file-alt"></i>
                    Resumen Ejecutivo del Día
                </div>
                <button class="ai-btn" id="generateSummaryBtn" onclick="generateSummary()">
                    <i class="fas fa-magic"></i>
                    Generar Resumen
                </button>
            </div>
            <div class="summary-content empty" id="summaryContent">
                <span>Haz clic en "Generar Resumen" para obtener un análisis con IA</span>
            </div>
        </div>

        <!-- Natural Language Query -->
        <div class="ai-card">
            <div class="ai-card-header">
                <div class="ai-card-title">
                    <i class="fas fa-comments"></i>
                    Consultas en Lenguaje Natural
                </div>
            </div>
            <form class="question-form" onsubmit="askQuestion(event)">
                <input 
                    type="text" 
                    class="question-input" 
                    id="questionInput"
                    placeholder="Ej: ¿Cuál fue el producto más vendido hoy?"
                    autocomplete="off"
                >
                <button type="submit" class="ai-btn" id="askBtn">
                    <i class="fas fa-paper-plane"></i>
                    Preguntar
                </button>
            </form>
            <div class="chat-history" id="chatHistory">
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <p>Haz preguntas sobre tu negocio en español.</p>
                    <p style="font-size: 0.85rem;">Ejemplos: ventas del día, productos más vendidos, inventario bajo...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const csrfToken = '{{ csrf_token }}';

    async function generateSummary() {
        const btn = document.getElementById('generateSummaryBtn');
        const content = document.getElementById('summaryContent');
        
        // Loading state
        btn.disabled = true;
        btn.classList.add('loading');
        btn.innerHTML = '<i class="fas fa-spinner"></i> Generando...';
        content.classList.remove('empty');
        content.innerHTML = `
            <div class="typing-indicator">
                <span></span><span></span><span></span>
            </div>
            <p style="text-align: center; color: #888;">La IA está analizando tus datos...</p>
        `;

        try {
            const response = await fetch('/analytics/generate-summary/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            });

            const data = await response.json();

            if (data.success) {
                // Format the summary with line breaks
                const formattedSummary = data.summary
                    .split('\n')
                    .filter(line => line.trim())
                    .map(line => `<p>${line}</p>`)
                    .join('');
                content.innerHTML = formattedSummary;
            } else {
                content.innerHTML = `<p style="color: #e74c3c;">Error: ${data.error}</p>`;
            }
        } catch (error) {
            content.innerHTML = `<p style="color: #e74c3c;">Error de conexión: ${error.message}</p>`;
        } finally {
            btn.disabled = false;
            btn.classList.remove('loading');
            btn.innerHTML = '<i class="fas fa-magic"></i> Generar Resumen';
        }
    }

    async function askQuestion(event) {
        event.preventDefault();
        
        const input = document.getElementById('questionInput');
        const btn = document.getElementById('askBtn');
        const chatHistory = document.getElementById('chatHistory');
        const question = input.value.trim();

        if (!question) return;

        // Clear empty state if present
        const emptyState = chatHistory.querySelector('.empty-state');
        if (emptyState) emptyState.remove();

        // Add user message
        chatHistory.innerHTML += `
            <div class="chat-message user">
                <div class="message-label">Tú</div>
                <div class="message-text">${escapeHtml(question)}</div>
            </div>
        `;

        // Add loading indicator
        const loadingId = 'loading-' + Date.now();
        chatHistory.innerHTML += `
            <div class="chat-message assistant" id="${loadingId}">
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;

        // Scroll to bottom
        chatHistory.scrollTop = chatHistory.scrollHeight;

        // Clear input and disable button
        input.value = '';
        btn.disabled = true;

        try {
            const response = await fetch('/analytics/ask/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ question })
            });

            const data = await response.json();
            const loadingEl = document.getElementById(loadingId);

            if (data.success) {
                const formattedAnswer = data.answer
                    .split('\n')
                    .filter(line => line.trim())
                    .map(line => line)
                    .join('<br>');
                
                loadingEl.innerHTML = `
                    <div class="message-label">DeepSeek IA</div>
                    <div class="message-text">${formattedAnswer}</div>
                `;
            } else {
                loadingEl.innerHTML = `
                    <div class="message-label">Error</div>
                    <div class="message-text" style="color: #e74c3c;">${data.error}</div>
                `;
            }
        } catch (error) {
            const loadingEl = document.getElementById(loadingId);
            loadingEl.innerHTML = `
                <div class="message-label">Error</div>
                <div class="message-text" style="color: #e74c3c;">Error de conexión: ${error.message}</div>
            `;
        } finally {
            btn.disabled = false;
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
