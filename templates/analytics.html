{% extends "base.html" %}
{% load static %}

{% block title %}Analytics IA{% endblock %}

{% block extra_css %}
<style>
    .analytics-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .analytics-header {
        margin-bottom: 30px;
    }

    .analytics-header h2 {
        color: var(--primary-color, #333);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .analytics-header h2 i {
        color: var(--accent-color, #667eea);
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 24px;
        color: white;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
    }

    .stat-card.sales {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        box-shadow: 0 10px 30px rgba(17, 153, 142, 0.3);
    }

    .stat-card.sales:hover {
        box-shadow: 0 15px 40px rgba(17, 153, 142, 0.4);
    }

    .stat-card.alert {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        box-shadow: 0 10px 30px rgba(235, 51, 73, 0.3);
    }

    .stat-card.alert:hover {
        box-shadow: 0 15px 40px rgba(235, 51, 73, 0.4);
    }

    .stat-card .stat-icon {
        font-size: 2.5rem;
        opacity: 0.8;
        margin-bottom: 10px;
    }

    .stat-card .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .stat-card .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    /* AI Section */
    .ai-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }

    @media (max-width: 1024px) {
        .ai-section {
            grid-template-columns: 1fr;
        }
    }

    .ai-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e8ecf4;
    }

    .ai-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f2f5;
    }

    .ai-card-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
    }

    .ai-card-title i {
        color: #667eea;
    }

    .ai-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .ai-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .ai-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .ai-btn.loading i {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Summary Content */
    .summary-content {
        min-height: 200px;
        padding: 20px;
        background: #f8f9fc;
        border-radius: 12px;
        line-height: 1.7;
        color: #444;
    }

    .summary-content.empty {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #888;
        font-style: italic;
    }

    .summary-content p {
        margin-bottom: 12px;
    }

    /* Question Form */
    .question-form {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
    }

    .question-input {
        flex: 1;
        padding: 14px 18px;
        border: 2px solid #e8ecf4;
        border-radius: 12px;
        font-size: 1rem;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .question-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .question-input::placeholder {
        color: #aab;
    }

    /* Chat History */
    .chat-history {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .chat-message {
        margin-bottom: 16px;
        padding: 16px;
        border-radius: 12px;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .chat-message.user {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: 20%;
    }

    .chat-message.assistant {
        background: #f0f2f5;
        color: #333;
        margin-right: 10%;
    }

    .chat-message .message-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.7;
        margin-bottom: 8px;
    }

    .chat-message .message-text {
        line-height: 1.6;
    }
    
    /* Fix: User message text must be black for visibility */
    .chat-message.user .message-text {
        color: black !important;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #888;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    /* Loading Animation */
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 16px;
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: #667eea;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Header con estilo HUB DE GESTI칍N -->
    <div class="welcome-banner" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; color: white;">
        <h1 style="margin: 0; font-size: 1.8rem; font-weight: 600;"><i class="fas fa-brain"></i> Analytics IA</h1>
        <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Sistema de Facturaci칩n Electr칩nica e Inteligencia de Inventarios</p>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card sales">
            <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
            <div class="stat-value" id="ventasHoyTotal">${{ quick_stats.ventas_hoy_total|floatformat:0|default:"0" }}</div>
            <div class="stat-label">Ventas Hoy ({{ quick_stats.ventas_hoy_cantidad|default:"0" }} transacciones)</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
            <div class="stat-value">{{ quick_stats.fecha|default:"--" }}</div>
            <div class="stat-label">Fecha Actual</div>
        </div>
        <div class="stat-card alert">
            <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="stat-value">{{ quick_stats.productos_stock_bajo|default:"0" }}</div>
            <div class="stat-label">Productos con Stock Bajo</div>
        </div>
    </div>

    <!-- AI Section -->
    <div class="ai-section">
        <!-- Daily Summary -->
        <div class="ai-card">
            <div class="ai-card-header">
                <div class="ai-card-title">
                    <i class="fas fa-file-alt"></i>
                    Resumen Ejecutivo del D칤a
                </div>
                <button class="ai-btn" id="generateSummaryBtn" onclick="generateSummary()">
                    <i class="fas fa-magic"></i>
                    Generar Resumen
                </button>
            </div>
            <div class="summary-content empty" id="summaryContent">
                <span>Haz clic en "Generar Resumen" para obtener un an치lisis con IA</span>
            </div>
        </div>

        <!-- Natural Language Query -->
        <div class="ai-card">
            <div class="ai-card-header">
                <div class="ai-card-title">
                    <i class="fas fa-comments"></i>
                    Consultas en Lenguaje Natural
                </div>
            </div>
            <form class="question-form" onsubmit="askQuestion(event)">
                <input 
                    type="text" 
                    class="question-input" 
                    id="questionInput"
                    placeholder="Ej: 쮺u치l fue el producto m치s vendido hoy?"
                    autocomplete="off"
                >
                <button type="submit" class="ai-btn" id="askBtn">
                    <i class="fas fa-paper-plane"></i>
                    Preguntar
                </button>
            </form>
            <div class="chat-history" id="chatHistory">
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <p>Haz preguntas sobre tu negocio en espa침ol.</p>
                    <p style="font-size: 0.85rem;">Ejemplos: ventas del d칤a, productos m치s vendidos, inventario bajo...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- Dashboard Unificado - Analytics ML & IA -->
    <!-- ============================================ -->
    <div class="unified-dashboard" id="unifiedDashboard">
        <div class="dashboard-header" style="margin: 30px 0 20px 0;">
            <h3 style="display: flex; align-items: center; gap: 10px; color: #333; font-size: 1.4rem;">
                <i class="fas fa-chart-line" style="color: #667eea;"></i>
                Dashboard Inteligente - Analytics ML & Recomendaciones
            </h3>
            <button class="ai-btn" onclick="cargarDashboardUnificado()" style="margin-top: 10px;">
                <i class="fas fa-sync-alt"></i>
                Actualizar Dashboard
            </button>
        </div>

        <!-- Loading State -->
        <div id="dashboardLoading" style="display: none; text-align: center; padding: 40px;">
            <div class="typing-indicator" style="justify-content: center;">
                <span></span><span></span><span></span>
            </div>
            <p style="color: #888;">Cargando datos del dashboard...</p>
        </div>

        <!-- Dashboard Content Grid -->
        <div class="dashboard-grid" id="dashboardContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            
            <!-- Clasificaci칩n ABC -->
            <div class="ai-card">
                <div class="ai-card-header">
                    <div class="ai-card-title">
                        <i class="fas fa-trophy" style="color: #f1c40f;"></i>
                        Clasificaci칩n ABC de Productos
                    </div>
                </div>
                <div id="abcContent" class="dashboard-metric">
                    <div class="abc-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                        <div class="abc-item" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 20px; border-radius: 12px; color: white;">
                            <div style="font-size: 2rem; font-weight: 700;" id="abcA">-</div>
                            <div style="opacity: 0.9;">Clase A</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Top ventas</div>
                        </div>
                        <div class="abc-item" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
                            <div style="font-size: 2rem; font-weight: 700;" id="abcB">-</div>
                            <div style="opacity: 0.9;">Clase B</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Importante</div>
                        </div>
                        <div class="abc-item" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white;">
                            <div style="font-size: 2rem; font-weight: 700;" id="abcC">-</div>
                            <div style="opacity: 0.9;">Clase C</div>
                            <div style="font-size: 0.75rem; opacity: 0.8;">Bajo impacto</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Anomal칤as Detectadas -->
            <div class="ai-card">
                <div class="ai-card-header">
                    <div class="ai-card-title">
                        <i class="fas fa-exclamation-circle" style="color: #e74c3c;"></i>
                        Anomal칤as Detectadas
                    </div>
                </div>
                <div id="anomaliasContent" class="dashboard-metric">
                    <div style="display: flex; justify-content: space-around; padding: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 700; color: #e74c3c;" id="anomaliasCriticas">0</div>
                            <div style="color: #666;">Cr칤ticas</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: 700; color: #f39c12;" id="anomaliasTotal">0</div>
                            <div style="color: #666;">Total (7 d칤as)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recomendaciones IA -->
            <div class="ai-card">
                <div class="ai-card-header">
                    <div class="ai-card-title">
                        <i class="fas fa-lightbulb" style="color: #f39c12;"></i>
                        Recomendaciones IA
                    </div>
                </div>
                <div id="recomendacionesContent" class="dashboard-metric">
                    <div class="recom-list" style="padding: 10px;">
                        <div class="recom-item" style="display: flex; align-items: center; gap: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; margin-bottom: 10px;">
                            <i class="fas fa-truck" style="color: #856404; font-size: 1.5rem;"></i>
                            <div>
                                <div style="font-weight: 600; color: #856404;">Reabastecer</div>
                                <div style="font-size: 1.2rem; font-weight: 700;" id="recomReabastecer">-</div>
                            </div>
                        </div>
                        <div class="recom-item" style="display: flex; align-items: center; gap: 15px; padding: 12px; background: #cce5ff; border-radius: 8px; margin-bottom: 10px;">
                            <i class="fas fa-star" style="color: #004085; font-size: 1.5rem;"></i>
                            <div>
                                <div style="font-weight: 600; color: #004085;">Productos Estrella</div>
                                <div style="font-size: 1.2rem; font-weight: 700;" id="recomEstrella">-</div>
                            </div>
                        </div>
                        <div class="recom-item" style="display: flex; align-items: center; gap: 15px; padding: 12px; background: #f8d7da; border-radius: 8px;">
                            <i class="fas fa-tag" style="color: #721c24; font-size: 1.5rem;"></i>
                            <div>
                                <div style="font-weight: 600; color: #721c24;">Liquidar</div>
                                <div style="font-size: 1.2rem; font-weight: 700;" id="recomLiquidar">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alertas del Sistema -->
            <div class="ai-card">
                <div class="ai-card-header">
                    <div class="ai-card-title">
                        <i class="fas fa-bell" style="color: #3498db;"></i>
                        Alertas Activas
                    </div>
                </div>
                <div id="alertasContent" class="dashboard-metric" style="max-height: 250px; overflow-y: auto;">
                    <div class="alertas-list" id="alertasList" style="padding: 10px;">
                        <p style="text-align: center; color: #888; padding: 20px;">
                            <i class="fas fa-check-circle" style="color: #27ae60; font-size: 2rem;"></i><br>
                            Sin alertas activas
                        </p>
                    </div>
                </div>
            </div>

        </div>

        <!-- Estado del Sistema -->
        <div class="system-status" style="margin-top: 20px; padding: 15px; background: #f8f9fc; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-server" style="color: #27ae60;"></i>
                <span style="color: #666;">Estado del Sistema:</span>
                <span id="sistemaEstado" style="font-weight: 600; color: #27ae60;">Verificando...</span>
            </div>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <span id="moduloCore" style="font-size: 0.85rem;"><i class="fas fa-circle" style="color: #ccc;"></i> Core</span>
                <span id="moduloAnalytics" style="font-size: 0.85rem;"><i class="fas fa-circle" style="color: #ccc;"></i> Analytics</span>
                <span id="moduloIA" style="font-size: 0.85rem;"><i class="fas fa-circle" style="color: #ccc;"></i> IA</span>
                <span id="moduloDB" style="font-size: 0.85rem;"><i class="fas fa-circle" style="color: #ccc;"></i> Base de Datos</span>
            </div>
            <div style="font-size: 0.8rem; color: #888;">
                칔ltima actualizaci칩n: <span id="ultimaActualizacion">--</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const csrfToken = '{{ csrf_token }}';

    async function generateSummary() {
        const btn = document.getElementById('generateSummaryBtn');
        const content = document.getElementById('summaryContent');
        
        // Loading state
        btn.disabled = true;
        btn.classList.add('loading');
        btn.innerHTML = '<i class="fas fa-spinner"></i> Generando...';
        content.classList.remove('empty');
        content.innerHTML = `
            <div class="typing-indicator">
                <span></span><span></span><span></span>
            </div>
            <p style="text-align: center; color: #888;">La IA est치 analizando tus datos...</p>
        `;

        try {
            const response = await fetch('/analytics/generate-summary/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            });

            const data = await response.json();

            if (data.success) {
                // Format the summary with line breaks
                const formattedSummary = data.summary
                    .split('\n')
                    .filter(line => line.trim())
                    .map(line => `<p>${line}</p>`)
                    .join('');
                content.innerHTML = formattedSummary;
            } else {
                content.innerHTML = `<p style="color: #e74c3c;">Error: ${data.error}</p>`;
            }
        } catch (error) {
            content.innerHTML = `<p style="color: #e74c3c;">Error de conexi칩n: ${error.message}</p>`;
        } finally {
            btn.disabled = false;
            btn.classList.remove('loading');
            btn.innerHTML = '<i class="fas fa-magic"></i> Generar Resumen';
        }
    }

    async function askQuestion(event) {
        event.preventDefault();
        
        const input = document.getElementById('questionInput');
        const btn = document.getElementById('askBtn');
        const chatHistory = document.getElementById('chatHistory');
        const question = input.value.trim();

        if (!question) return;

        // Clear empty state if present
        const emptyState = chatHistory.querySelector('.empty-state');
        if (emptyState) emptyState.remove();

        // Add user message
        chatHistory.innerHTML += `
            <div class="chat-message user">
                <div class="message-label">T칰</div>
                <div class="message-text">${escapeHtml(question)}</div>
            </div>
        `;

        // Add loading indicator
        const loadingId = 'loading-' + Date.now();
        chatHistory.innerHTML += `
            <div class="chat-message assistant" id="${loadingId}">
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;

        // Scroll to bottom
        chatHistory.scrollTop = chatHistory.scrollHeight;

        // Clear input and disable button
        input.value = '';
        btn.disabled = true;

        try {
            const response = await fetch('/analytics/ask/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ question })
            });

            const data = await response.json();
            const loadingEl = document.getElementById(loadingId);

            if (data.success) {
                const formattedAnswer = data.answer
                    .split('\n')
                    .filter(line => line.trim())
                    .map(line => line)
                    .join('<br>');
                
                loadingEl.innerHTML = `
                    <div class="message-label">DeepSeek IA</div>
                    <div class="message-text">${formattedAnswer}</div>
                `;
            } else {
                loadingEl.innerHTML = `
                    <div class="message-label">Error</div>
                    <div class="message-text" style="color: #e74c3c;">${data.error}</div>
                `;
            }
        } catch (error) {
            const loadingEl = document.getElementById(loadingId);
            loadingEl.innerHTML = `
                <div class="message-label">Error</div>
                <div class="message-text" style="color: #e74c3c;">Error de conexi칩n: ${error.message}</div>
            `;
        } finally {
            btn.disabled = false;
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ============================================
    // Dashboard Unificado - Carga de datos
    // ============================================

    async function cargarDashboardUnificado() {
        const loading = document.getElementById('dashboardLoading');
        const content = document.getElementById('dashboardContent');
        
        loading.style.display = 'block';
        
        try {
            // Cargar datos en paralelo
            const [dashboardData, healthData] = await Promise.all([
                fetchDashboardData(),
                fetchHealthData()
            ]);
            
            // Actualizar UI con los datos
            actualizarDashboardUI(dashboardData);
            actualizarHealthUI(healthData);
            
            // Actualizar timestamp
            document.getElementById('ultimaActualizacion').textContent = 
                new Date().toLocaleTimeString();
            
        } catch (error) {
            console.error('Error cargando dashboard:', error);
            document.getElementById('sistemaEstado').textContent = 'Error';
            document.getElementById('sistemaEstado').style.color = '#e74c3c';
        } finally {
            loading.style.display = 'none';
        }
    }

    async function fetchDashboardData() {
        try {
            const response = await fetch('/api/core/dashboard-unificado/', {
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });
            return await response.json();
        } catch (error) {
            console.error('Error fetching dashboard:', error);
            return null;
        }
    }

    async function fetchHealthData() {
        try {
            const response = await fetch('/api/core/health-global/');
            return await response.json();
        } catch (error) {
            console.error('Error fetching health:', error);
            return null;
        }
    }

    function actualizarDashboardUI(data) {
        if (!data || !data.exito) return;
        
        const secciones = data.secciones || {};
        
        // Actualizar Analytics (ABC)
        const analytics = secciones.analytics || {};
        const abc = analytics.productos_abc || {};
        document.getElementById('abcA').textContent = abc.A || 0;
        document.getElementById('abcB').textContent = abc.B || 0;
        document.getElementById('abcC').textContent = abc.C || 0;
        
        // Actualizar Anomal칤as
        const anomalias = analytics.anomalias || {};
        document.getElementById('anomaliasCriticas').textContent = anomalias.criticas || 0;
        document.getElementById('anomaliasTotal').textContent = anomalias.total || 0;
        
        // Actualizar Recomendaciones IA
        const ia = secciones.ia || {};
        document.getElementById('recomReabastecer').textContent = 
            (ia.productos_reabastecer || 0) + ' productos';
        document.getElementById('recomEstrella').textContent = 
            (ia.productos_estrella || 0) + ' productos';
        document.getElementById('recomLiquidar').textContent = 
            (ia.productos_liquidar || 0) + ' productos';
        
        // Actualizar Alertas
        const alertas = data.alertas || [];
        actualizarAlertasUI(alertas);
    }

    function actualizarAlertasUI(alertas) {
        const container = document.getElementById('alertasList');
        
        if (!alertas || alertas.length === 0) {
            container.innerHTML = `
                <p style="text-align: center; color: #888; padding: 20px;">
                    <i class="fas fa-check-circle" style="color: #27ae60; font-size: 2rem;"></i><br>
                    Sin alertas activas
                </p>
            `;
            return;
        }
        
        const alertaColors = {
            'CRITICA': { bg: '#f8d7da', border: '#f5c6cb', icon: '#721c24', iconClass: 'fa-exclamation-triangle' },
            'ALTA': { bg: '#fff3cd', border: '#ffeeba', icon: '#856404', iconClass: 'fa-exclamation-circle' },
            'MEDIA': { bg: '#cce5ff', border: '#b8daff', icon: '#004085', iconClass: 'fa-info-circle' }
        };
        
        container.innerHTML = alertas.map(alerta => {
            const color = alertaColors[alerta.tipo] || alertaColors['MEDIA'];
            return `
                <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; 
                            background: ${color.bg}; border-left: 4px solid ${color.icon}; 
                            border-radius: 8px; margin-bottom: 10px;">
                    <i class="fas ${color.iconClass}" style="color: ${color.icon}; font-size: 1.2rem; margin-top: 2px;"></i>
                    <div>
                        <div style="font-weight: 600; color: ${color.icon}; font-size: 0.85rem;">${alerta.tipo} - ${alerta.modulo}</div>
                        <div style="color: #333; margin: 4px 0;">${alerta.mensaje}</div>
                        <div style="font-size: 0.8rem; color: #666;">游눠 ${alerta.accion}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function actualizarHealthUI(data) {
        if (!data) return;
        
        const estado = data.status === 'healthy' ? 'Operativo' : 'Degradado';
        const estadoEl = document.getElementById('sistemaEstado');
        estadoEl.textContent = estado;
        estadoEl.style.color = data.status === 'healthy' ? '#27ae60' : '#f39c12';
        
        const modulos = data.modulos || {};
        
        // Actualizar indicadores de m칩dulos
        actualizarModuloIndicador('moduloCore', modulos.core);
        actualizarModuloIndicador('moduloAnalytics', modulos.analytics);
        actualizarModuloIndicador('moduloIA', modulos.ia);
        actualizarModuloIndicador('moduloDB', modulos.base_datos);
    }

    function actualizarModuloIndicador(elementId, activo) {
        const el = document.getElementById(elementId);
        if (!el) return;
        
        const icon = el.querySelector('i');
        if (icon) {
            icon.style.color = activo ? '#27ae60' : '#e74c3c';
        }
    }

    // Cargar dashboard al iniciar la p치gina
    document.addEventListener('DOMContentLoaded', function() {
        cargarDashboardUnificado();
        
        // Actualizar cada 5 minutos
        setInterval(cargarDashboardUnificado, 5 * 60 * 1000);
    });
</script>
{% endblock %}
